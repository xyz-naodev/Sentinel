<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Sentinel - Analytics</title>

  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="../css/dashboard.css">
  <link rel="stylesheet" href="../css/analytics.css">
  <link rel="stylesheet" href="../css/loading.css">
  <link rel="stylesheet" href="../css/notification.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth.js"></script>

  <!-- Firebase Web Service & Auth -->
  <script src="../js/firebase-web-service.js"></script>
  <script src="../js/firebase-auth-service.js"></script>
  <script src="../js/page-auth-guard.js"></script>
  
  <!-- Initialize Notification Manager with Firebase -->
  <script>
    // Hook notification manager to Firebase incidents
    if (typeof firebaseService !== 'undefined' && window.notificationManager) {
      // Listen to incidents updates
      firebaseService.onIncidentsChange((incidents) => {
        if (incidents && incidents.length > 0) {
          window.notificationManager.checkForNewIncidents(incidents);
        }
      });
      
      // Initial load
      if (firebaseService.incidents && firebaseService.incidents.length > 0) {
        window.notificationManager.checkForNewIncidents(firebaseService.incidents);
      }
    }
  </script>
</head>
<body>

<div class="dashboard-container">
  <aside class="sidebar">
    <div class="sidebar-header">
      <img src="../img/Dashboard-logo.png" alt="Sentinel Logo" class="sidebar-logo-img">
    </div>

    <div class="sidebar-user">
      <div class="user-avatar">
        <i class="fa-solid fa-user"></i>
      </div>
      <div class="user-info">
        <h4>ADMIN</h4>
        <p>Online</p>
      </div>
    </div>

    <ul class="sidebar-nav">
      <li><a href="dashboard.html"><i class="fa-solid fa-table-columns"></i> Dashboard</a></li>
      <li><a href="incireport.html"><i class="fa-solid fa-clipboard-list"></i> Incident Reports</a></li>
      <li><a href="analytics.html" class="active"><i class="fa-solid fa-chart-simple"></i> Analytics</a></li>
      <li><a href="settings.html"><i class="fa-solid fa-gear"></i> Settings</a></li>
    </ul>

    <div class="sidebar-logout">
      <button id="logoutBtn" class="btn btn-secondary">
        <i class="fa-solid fa-right-from-bracket"></i> Sign Out
      </button>
    </div>
  </aside>

  <main class="main-content">
    <div class="top-bar">
      <div class="top-bar-left">
        <input type="text" class="top-bar-search" placeholder="Search...">
      </div>
      <div class="top-bar-right">
        <div style="position: relative; display: inline-block;">
          <i class="top-bar-icon fa-solid fa-bell" id="notificationBell" style="cursor: pointer; font-size: 18px; transition: transform 0.2s;" title="Notifications"></i>
          <span id="notificationBadge" style="position: absolute; top: -8px; right: -8px; background: #B00020; color: white; border-radius: 50%; width: 24px; height: 24px; display: none; align-items: center; justify-content: center; font-size: 12px; font-weight: 600;"></span>
          
          <!-- Notification Panel -->
          <div id="notificationPanel" style="position: absolute; top: 40px; right: 0; background: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.15); width: 380px; max-height: 500px; display: none; z-index: 1000; flex-direction: column; overflow: hidden; pointer-events: none;">
            <div style="padding: 14px 16px; border-bottom: 1px solid #eee; background: #f9f9f9; display: flex; justify-content: space-between; align-items: center;">
              <h3 style="margin: 0; font-size: 15px; color: #333; font-weight: 600;">Notifications</h3>
              <button id="clearAllNotifications" style="background: none; border: none; color: #999; cursor: pointer; font-size: 13px; padding: 4px 8px; transition: color 0.2s;" title="Clear all">Clear All</button>
            </div>
            <div id="notificationPanelContent" style="overflow-y: auto; flex: 1;">
              <div style="padding: 20px; text-align: center; color: #999;">Loading...</div>
            </div>
          </div>
        </div>
        
        <i class="top-bar-icon fa-solid fa-circle-info" id="filterInfoIcon" style="cursor: pointer;"></i>
        <div class="admin-section">
          <span>ADMIN</span>
          <div class="admin-avatar">
            <i class="fa-solid fa-user"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="page-content">
      <div class="page-header">
        <h1>Analytics</h1>
        <p class="page-timestamp">As of <span id="as-of-time">10:59 PM</span> <i class="fa-solid fa-rotate-right"></i></p>
      </div>

      <!-- STATISTICS CARDS -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
        <!-- Total Incidents Card -->
        <div class="card" style="padding: 20px; text-align: center;">
          <div style="font-size: 12px; color: #999; margin-bottom: 10px; text-transform: uppercase; font-weight: 600;">Total Incidents</div>
          <div style="font-size: 32px; font-weight: bold; color: var(--primary-red); margin-bottom: 8px;" id="statTotalIncidents">0</div>
          <div style="font-size: 12px; color: #666;">All time incidents</div>
        </div>

        <!-- Resolved Incidents Card -->
        <div class="card" style="padding: 20px; text-align: center;">
          <div style="font-size: 12px; color: #999; margin-bottom: 10px; text-transform: uppercase; font-weight: 600;">Resolved</div>
          <div style="font-size: 32px; font-weight: bold; color: #4CAF50; margin-bottom: 8px;" id="statResolvedIncidents">0</div>
          <div style="font-size: 12px; color: #666;">Completed incidents</div>
        </div>

        <!-- In Progress Card -->
        <div class="card" style="padding: 20px; text-align: center;">
          <div style="font-size: 12px; color: #999; margin-bottom: 10px; text-transform: uppercase; font-weight: 600;">In Progress</div>
          <div style="font-size: 32px; font-weight: bold; color: #FF9800; margin-bottom: 8px;" id="statInProgressIncidents">0</div>
          <div style="font-size: 12px; color: #666;">Being handled</div>
        </div>

        <!-- Pending Card -->
        <div class="card" style="padding: 20px; text-align: center;">
          <div style="font-size: 12px; color: #999; margin-bottom: 10px; text-transform: uppercase; font-weight: 600;">Pending</div>
          <div style="font-size: 32px; font-weight: bold; color: #2196F3; margin-bottom: 8px;" id="statPendingIncidents">0</div>
          <div style="font-size: 12px; color: #666;">Acknowledged/New</div>
        </div>
      </div>

      <!-- Two Column Layout -->
      <div class="analytics-layout">
        <!-- LEFT COLUMN: CHARTS & TABLE (30%) -->
        <div class="analytics-left">
          <!-- ANALYTICS CHART CONTAINER WITH DROPDOWN -->
          <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
              <h3 style="margin: 0;">Analytics Overview</h3>
              <select id="chartSelector" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; background: white; cursor: pointer;">
                <option value="trends">Event Trends</option>
                <option value="type">Incident Type Breakdown</option>
                <option value="severity">Severity Distribution</option>
              </select>
            </div>
            
            <!-- DATE RANGE FILTER (visible only when Event Trends is selected) -->
            <div id="dateRangeFilter" style="margin-bottom: 15px; padding: 12px; background: #f5f5f5; border-radius: 6px; display: block;">
              <div style="font-size: 12px; font-weight: 600; margin-bottom: 10px; color: #666;">Filter by Date Range:</div>
              <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <button class="date-range-btn" data-range="today" style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer; font-size: 12px; transition: all 0.3s;">Today</button>
                <button class="date-range-btn" data-range="week" style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer; font-size: 12px; transition: all 0.3s;">This Week</button>
                <button class="date-range-btn" data-range="month" style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer; font-size: 12px; transition: all 0.3s;">This Month</button>
                <button class="date-range-btn" data-range="all" style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer; font-size: 12px; transition: all 0.3s;">All Time</button>
                <button id="customRangeBtn" style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer; font-size: 12px; transition: all 0.3s;">Custom Range</button>
              </div>
              <!-- Custom date range inputs (hidden by default) -->
              <div id="customRangeInputs" style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid #ddd;">
                <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                  <div>
                    <label style="font-size: 11px; color: #666; display: block; margin-bottom: 4px;">From:</label>
                    <input type="date" id="customStartDate" style="padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                  </div>
                  <div>
                    <label style="font-size: 11px; color: #666; display: block; margin-bottom: 4px;">To:</label>
                    <input type="date" id="customEndDate" style="padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                  </div>
                  <button id="applyCustomRange" style="padding: 6px 12px; background: #FF6B00; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin-top: 20px;">Apply</button>
                </div>
              </div>
            </div>
            
            <div id="chartContainer" style="position: relative; height: 300px; width: 100%;">
              <canvas id="trendsChart" style="display: block; max-height: 300px;"></canvas>
              <canvas id="typeChart" style="display: none; max-height: 300px;"></canvas>
              <canvas id="severityChart" style="display: none; max-height: 300px;"></canvas>
            </div>
          </div>

          <!-- TANOD AVAILABILITY CONTAINER -->
          <div class="card">
            <h3>Tanod Availability &amp; Status List</h3>
            <table data-table="tanod" style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="border-bottom: 2px solid #e0e0e0;">
                  <th style="padding: 12px; text-align: left; font-weight: 600; font-size: 13px;">Name</th>
                  <th style="padding: 12px; text-align: left; font-weight: 600; font-size: 13px;">Status</th>
                  <th style="padding: 12px; text-align: left; font-weight: 600; font-size: 13px;">No. of Incident</th>
                </tr>
              </thead>
              <tbody>
                <tr style="border-bottom: 1px solid #e0e0e0;"><td style="padding: 12px; font-size: 13px;">Tanod 1</td><td style="padding: 12px; font-size: 13px;">Available</td><td style="padding: 12px; font-size: 13px;">3</td></tr>
                <tr style="border-bottom: 1px solid #e0e0e0;"><td style="padding: 12px; font-size: 13px;">Tanod 2</td><td style="padding: 12px; font-size: 13px;">On Duty</td><td style="padding: 12px; font-size: 13px;">5</td></tr>
                <tr style="border-bottom: 1px solid #e0e0e0;"><td style="padding: 12px; font-size: 13px;">Tanod 3</td><td style="padding: 12px; font-size: 13px;">Unavailable</td><td style="padding: 12px; font-size: 13px;">0</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- RIGHT COLUMN: MAP (70%) -->
        <div class="analytics-right">
          <!-- MAP CONTAINER -->
          <div class="card" style="height: auto !important; padding: 0 !important;">
            <h3 style="padding: 18px 18px 0 18px; margin: 0 0 15px 0;">Interactive Map with Heat Zones</h3>
            <div id="map" class="map-canvas" style="height: 650px; width: 100%; border-radius: 0 0 10px 10px; overflow: hidden; position: relative; flex: 0 0 auto; box-sizing: border-box;"></div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- Utilities and Logging -->
<script src="../js/utils.js"></script>

<!-- ACCESSIBILITY ENHANCEMENTS (ARIA labels, keyboard nav, color contrast) -->
<script src="../js/accessibility-enhancements.js"></script>

<!-- NOTIFICATION MANAGER -->
<script src="../js/notification-manager.js"></script>

<!-- NOTIFICATION SYSTEM -->
<script src="../js/notification-system.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Firebase (used by sentinel-app.js) -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<!-- App core (live data, Google Maps helpers) -->
<!-- Core app state (defines global `state`) -->
<script src="../js/core/app-state.js"></script>
<script src="../js/sentinel-app.js"></script>
<!-- Google Maps API with heatmap visualization -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCk1YpkJBfimFaX5sPjqSPjpCd8iDeA7ro&libraries=visualization&callback=initMap" async defer></script>
<script src="../js/asof-clock.js"></script>

<!-- Analytics page initialization with error handling -->
<script>
  let chartsInitialized = false;
  let allIncidents = [];
  let tanodData = [];
  let chartInstances = {};
  let currentDateRange = 'week'; // Default to this week
  let filteredIncidents = [];

  /**
   * Update statistics cards with incident data
   */
  function updateStatisticsCards() {
    const totalIncidents = allIncidents.length;
    const resolvedIncidents = allIncidents.filter(i => {
      const status = (i.status || '').toLowerCase().trim();
      return status === 'resolved';
    }).length;
    const inProgressIncidents = allIncidents.filter(i => {
      const status = (i.status || '').toLowerCase().trim();
      return status === 'in_progress' || status === 'in progress';
    }).length;
    const pendingIncidents = allIncidents.filter(i => {
      const status = (i.status || '').toLowerCase().trim();
      return status === 'new' || status === 'acknowledged' || status === 'pending';
    }).length;

    document.getElementById('statTotalIncidents').textContent = totalIncidents;
    document.getElementById('statResolvedIncidents').textContent = resolvedIncidents;
    document.getElementById('statInProgressIncidents').textContent = inProgressIncidents;
    document.getElementById('statPendingIncidents').textContent = pendingIncidents;

    console.log('[Analytics] Updated statistics - Total:', totalIncidents, 'Resolved:', resolvedIncidents, 'In Progress:', inProgressIncidents, 'Pending:', pendingIncidents);
  }

  /**
   * Update Incident Type Breakdown pie chart
   */
  function updateTypeChart() {
    const typeMap = {};
    const colors = ['#FF6B00', '#FF9800', '#FFC107', '#4CAF50', '#2196F3', '#9C27B0', '#F44336'];
    
    allIncidents.forEach(incident => {
      const type = incident.type || 'Unknown';
      typeMap[type] = (typeMap[type] || 0) + 1;
    });

    const types = Object.keys(typeMap);
    const counts = Object.values(typeMap);
    const assignedColors = colors.slice(0, types.length);

    const ctx = document.getElementById('typeChart');
    if (ctx) {
      // Destroy existing chart if it exists
      if (chartInstances.typeChart) {
        chartInstances.typeChart.destroy();
      }

      chartInstances.typeChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: types,
          datasets: [{
            data: counts,
            backgroundColor: assignedColors,
            borderColor: '#fff',
            borderWidth: 2,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                boxWidth: 12,
                font: { size: 11 }
              }
            }
          }
        }
      });
    }
  }

  /**
   * Update Severity Distribution bar chart
   */
  function updateSeverityChart() {
    const severityMap = { 'CRITICAL': 0, 'HIGH': 0, 'MEDIUM': 0, 'LOW': 0 };
    
    allIncidents.forEach(incident => {
      const severity = incident.severity || 'LOW';
      if (severity in severityMap) {
        severityMap[severity]++;
      }
    });

    const severities = Object.keys(severityMap);
    const counts = Object.values(severityMap);
    const colors = ['#FF0000', '#FF9800', '#FFC107', '#4CAF50'];

    const ctx = document.getElementById('severityChart');
    if (ctx) {
      // Destroy existing chart if it exists
      if (chartInstances.severityChart) {
        chartInstances.severityChart.destroy();
      }

      chartInstances.severityChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: severities,
          datasets: [{
            label: 'Number of Incidents',
            data: counts,
            backgroundColor: colors,
            borderColor: colors.map(c => c.replace(')', ', 0.7)')),
            borderWidth: 1,
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: true,
              position: 'top',
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          }
        }
      });
    }
  }

  /**
   * Fetch incidents from REST API
   */
  function fetchIncidentsData() {
    const dbURL = 'https://sentinel-tanod-system-default-rtdb.asia-southeast1.firebasedatabase.app/incidents.json';
    
    console.log('[Analytics] Fetching incidents from:', dbURL);
    
    fetch(dbURL)
      .then(response => {
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return response.json();
      })
      .then(data => {
        if (data && typeof data === 'object') {
          allIncidents = [];
          Object.keys(data).forEach((key) => {
            allIncidents.push({
              id: key,
              ...data[key],
            });
          });
          console.log('[Analytics] Loaded', allIncidents.length, 'incidents');
          
          // Check for new incidents and update notification manager
          if (typeof window.notificationManager !== 'undefined' && window.notificationManager) {
            window.notificationManager.checkForNewIncidents(allIncidents);
          }
          
          enrichIncidentsWithLocations();
          updateStatisticsCards();
          updateEventTrendsChart();  // This will call showChart('trends') for initial display
          updateTypeChart();
          updateSeverityChart();
          // Update map if function is available
          if (window.updateMapWithIncidents) {
            window.updateMapWithIncidents();
          }
        } else {
          console.warn('[Analytics] No incidents data received, data is:', data);
        }
      })
      .catch(error => {
        console.error('[Analytics] Error fetching incidents:', error);
        // Initialize with empty array if fetch fails - charts will show "No Data"
        if (allIncidents.length === 0) {
          console.log('[Analytics] No incidents to display');
          updateStatisticsCards();
          updateEventTrendsChart();
          updateTypeChart();
          updateSeverityChart();
          // Update map if function is available
          if (window.updateMapWithIncidents) {
            window.updateMapWithIncidents();
          }
        }
      });
  }

  /**
   * Fetch tanod/responder data from REST API
   */
  function fetchTanodData() {
    const dbURL = 'https://sentinel-tanod-system-default-rtdb.asia-southeast1.firebasedatabase.app/tanods.json';
    
    fetch(dbURL)
      .then(response => {
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return response.json();
      })
      .then(data => {
        if (data && typeof data === 'object') {
          tanodData = [];
          Object.keys(data).forEach((key) => {
            tanodData.push({
              id: key,
              ...data[key],
            });
          });
          console.log('[Analytics] Loaded', tanodData.length, 'tanod records');
          updateTanodTable();
        }
      })
      .catch(error => {
        console.error('[Analytics] Error fetching tanod data:', error);
        // Generate mock data if endpoint doesn't exist
        generateMockTanodData();
      });
  }

  /**
   * Generate mock tanod data for demonstration
   */
  function generateMockTanodData() {
    tanodData = [
      { id: 1, name: 'Tanod 1 (Main Unit)', status: 'Available', incidents: 3 },
      { id: 2, name: 'Tanod 2', status: 'Available', incidents: 0 },
    ];
    console.log('[Analytics] Using mock tanod data');
    updateTanodTable();
  }

  /**
   * Set up real-time listener for incident updates
   * Refreshes analytics whenever incidents change in Firebase
   */
  function setupIncidentListener() {
    const dbURL = 'https://sentinel-tanod-system-default-rtdb.asia-southeast1.firebasedatabase.app/incidents';
    
    // Use a simple polling approach since we're not using Firebase SDK listeners
    // Check for updates every 5 seconds
    setInterval(() => {
      fetch(dbURL + '.json')
        .then(response => {
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          return response.json();
        })
        .then(data => {
          if (data && typeof data === 'object') {
            const newIncidents = [];
            Object.keys(data).forEach((key) => {
              newIncidents.push({
                id: key,
                firebaseKey: key,
                ...data[key],
              });
            });
            
            // Only update if data has changed (different count or content)
            if (newIncidents.length !== allIncidents.length || 
                JSON.stringify(newIncidents) !== JSON.stringify(allIncidents)) {
              console.log('[Analytics] Detected incident updates, refreshing...');
              allIncidents = newIncidents;
              
              // Check for new incidents and update notification manager
              if (typeof window.notificationManager !== 'undefined' && window.notificationManager) {
                window.notificationManager.checkForNewIncidents(newIncidents);
              }
              
              enrichIncidentsWithLocations();
              updateStatisticsCards();
              updateEventTrendsChart();
              updateTypeChart();
              updateSeverityChart();
              if (window.updateMapWithIncidents) {
                window.updateMapWithIncidents();
              }
            }
          }
        })
        .catch(error => {
          console.error('[Analytics] Error in incident listener:', error);
        });
    }, 5000); // Poll every 5 seconds
  }

  /**
   * Calculate date range based on selected filter
   */
  function getDateRange(rangeType) {
    const now = new Date();
    now.setHours(0, 0, 0, 0);
    let startDate = new Date(now);
    
    switch(rangeType) {
      case 'today':
        // Just today
        break;
      case 'week':
        // Last 7 days
        startDate.setDate(now.getDate() - 7);
        break;
      case 'month':
        // Last 30 days
        startDate.setDate(now.getDate() - 30);
        break;
      case 'all':
        // Far past date
        startDate = new Date(2000, 0, 1);
        break;
      default:
        startDate.setDate(now.getDate() - 7);
    }
    
    return { startDate, endDate: new Date(now.getTime() + 86400000) }; // +1 day for inclusive end
  }

  /**
   * Filter incidents based on date range
   */
  function filterIncidentsByDateRange(incidents, rangeType) {
    if (rangeType === 'custom') {
      const startDateInput = document.getElementById('customStartDate').value;
      const endDateInput = document.getElementById('customEndDate').value;
      
      if (!startDateInput || !endDateInput) return incidents;
      
      const startDate = new Date(startDateInput);
      const endDate = new Date(endDateInput);
      endDate.setHours(23, 59, 59, 999);
      
      return incidents.filter(incident => {
        const incidentDate = new Date(incident.timestamp || incident.createdAt || 0);
        return incidentDate >= startDate && incidentDate <= endDate;
      });
    }
    
    const { startDate, endDate } = getDateRange(rangeType);
    return incidents.filter(incident => {
      const incidentDate = new Date(incident.timestamp || incident.createdAt || 0);
      return incidentDate >= startDate && incidentDate <= endDate;
    });
  }

  /**
   * Update Event Trends chart with real incident data
   */
  function updateEventTrendsChart() {
    // Filter incidents based on current date range
    filteredIncidents = filterIncidentsByDateRange(allIncidents, currentDateRange);
    console.log('[Analytics] Filtered incidents for chart:', filteredIncidents.length, 'out of', allIncidents.length);
    
    // Group incidents by date
    const dateMap = {};
    filteredIncidents.forEach(incident => {
      const timestamp = incident.timestamp || incident.createdAt || 0;
      const date = new Date(timestamp);
      const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      
      if (!dateMap[dateStr]) {
        dateMap[dateStr] = { total: 0, critical: 0, high: 0 };
      }
      dateMap[dateStr].total++;
      
      if (incident.severity === 'CRITICAL') {
        dateMap[dateStr].critical++;
      } else if (incident.severity === 'HIGH') {
        dateMap[dateStr].high++;
      }
    });

    // Get last 12 data points
    const labels = Object.keys(dateMap).slice(-12);
    const totalData = labels.map(label => dateMap[label].total);
    const severityData = labels.map(label => dateMap[label].critical + dateMap[label].high);

    console.log('[Analytics] Chart labels:', labels, 'totalData:', totalData, 'severityData:', severityData);

    const ctx = document.getElementById('trendsChart');
    if (ctx) {
      // Destroy existing chart if it exists
      if (chartInstances.trendsChart) {
        chartInstances.trendsChart.destroy();
      }

      chartInstances.trendsChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels.length > 0 ? labels : ['No Data'],
          datasets: [
            {
              label: 'Total Incidents',
              data: totalData.length > 0 ? totalData : [0],
              borderColor: '#FF6B00',
              backgroundColor: 'rgba(255, 107, 0, 0.1)',
              fill: true,
              tension: 0.3,
              borderWidth: 2,
            },
            {
              label: 'High Severity',
              data: severityData.length > 0 ? severityData : [0],
              borderColor: '#4CAF50',
              backgroundColor: 'rgba(76, 175, 80, 0.1)',
              fill: true,
              tension: 0.3,
              borderWidth: 2,
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: true,
              position: 'top',
            }
          },
          scales: {
            y: {
              beginAtZero: true,
            }
          }
        }
      });
      chartsInitialized = true;
      showChart('trends'); // Show trends chart by default
      console.log('[Analytics] Event trends chart updated');
    } else {
      console.error('[Analytics] trendsChart canvas not found');
    }
  }

  /**
   * Update Tanod Availability table with real data
   */
  function updateTanodTable() {
    const table = document.querySelector('[data-table="tanod"]');
    if (!table) return;

    let html = `
      <tr style="border-bottom: 2px solid #e0e0e0;">
        <th style="padding: 12px; text-align: left; font-weight: 600; font-size: 13px;">Name</th>
        <th style="padding: 12px; text-align: left; font-weight: 600; font-size: 13px;">Status</th>
        <th style="padding: 12px; text-align: left; font-weight: 600; font-size: 13px;">No. of Incident</th>
      </tr>
    `;

    tanodData.forEach(tanod => {
      let statusColor = '#999';
      let statusBg = '#f5f5f5';
      
      if (tanod.status === 'Available') {
        statusColor = '#4CAF50';
        statusBg = '#E8F5E9';
      } else if (tanod.status === 'On Duty') {
        statusColor = '#FF9800';
        statusBg = '#FFF3E0';
      } else if (tanod.status === 'Unavailable') {
        statusColor = '#F44336';
        statusBg = '#FFEBEE';
      }

      html += `
        <tr style="border-bottom: 1px solid #e0e0e0;">
          <td style="padding: 12px; font-size: 13px; font-weight: 500;">${tanod.name || 'N/A'}</td>
          <td style="padding: 12px; font-size: 13px;">
            <span style="background: ${statusBg}; color: ${statusColor}; padding: 4px 8px; border-radius: 4px; font-weight: 600; font-size: 11px;">
              ${tanod.status || 'Unknown'}
            </span>
          </td>
          <td style="padding: 12px; font-size: 13px; font-weight: 500;">${tanod.incidents || 0}</td>
        </tr>
      `;
    });

    table.innerHTML = html;
    console.log('[Analytics] Updated tanod table with', tanodData.length, 'records');
  }

  /**
   * Initialize analytics with real data
   */
  function initializeAnalytics() {
    console.log('[Analytics] Initializing analytics with real data...');
    fetchIncidentsData();
    fetchTanodData();
    
    // Set up real-time listener for incident updates
    setupIncidentListener();

    // Setup chart selector dropdown
    const chartSelector = document.getElementById('chartSelector');
    if (chartSelector) {
      chartSelector.addEventListener('change', (e) => {
        const selectedChart = e.target.value;
        console.log('[Analytics] Chart selector changed to:', selectedChart);
        
        // Show/hide date range filter based on chart selection
        const dateRangeFilter = document.getElementById('dateRangeFilter');
        if (dateRangeFilter) {
          dateRangeFilter.style.display = selectedChart === 'trends' ? 'block' : 'none';
        }
        
        // Update the selected chart if needed
        if (selectedChart === 'type' && !chartInstances.typeChart) {
          updateTypeChart();
        } else if (selectedChart === 'severity' && !chartInstances.severityChart) {
          updateSeverityChart();
        }
        
        showChart(selectedChart);
      });
    }

    // Setup date range buttons
    const dateRangeButtons = document.querySelectorAll('.date-range-btn');
    dateRangeButtons.forEach(btn => {
      btn.addEventListener('click', (e) => {
        const range = e.target.getAttribute('data-range');
        console.log('[Analytics] Date range changed to:', range);
        
        // Update active button styling
        dateRangeButtons.forEach(b => {
          b.style.backgroundColor = 'white';
          b.style.borderColor = '#ddd';
          b.style.color = '#333';
          b.style.fontWeight = 'normal';
        });
        e.target.style.backgroundColor = '#FF6B00';
        e.target.style.borderColor = '#FF6B00';
        e.target.style.color = 'white';
        e.target.style.fontWeight = '600';
        
        // Hide custom range inputs when preset is selected
        const customRangeInputs = document.getElementById('customRangeInputs');
        if (customRangeInputs) {
          customRangeInputs.style.display = 'none';
        }
        
        // Update current date range and refresh chart
        currentDateRange = range;
        updateEventTrendsChart();
      });
    });

    // Setup custom range button
    const customRangeBtn = document.getElementById('customRangeBtn');
    if (customRangeBtn) {
      customRangeBtn.addEventListener('click', () => {
        const customRangeInputs = document.getElementById('customRangeInputs');
        if (customRangeInputs) {
          customRangeInputs.style.display = customRangeInputs.style.display === 'none' ? 'block' : 'none';
        }
      });
    }

    // Setup apply custom range button
    const applyCustomRange = document.getElementById('applyCustomRange');
    if (applyCustomRange) {
      applyCustomRange.addEventListener('click', () => {
        const startDateInput = document.getElementById('customStartDate').value;
        const endDateInput = document.getElementById('customEndDate').value;
        
        if (!startDateInput || !endDateInput) {
          alert('Please select both start and end dates');
          return;
        }
        
        console.log('[Analytics] Custom date range applied:', startDateInput, 'to', endDateInput);
        
        // Update active button styling
        dateRangeButtons.forEach(b => {
          b.style.backgroundColor = 'white';
          b.style.borderColor = '#ddd';
          b.style.color = '#333';
          b.style.fontWeight = 'normal';
        });
        
        // Set custom button as active
        const customBtn = document.getElementById('customRangeBtn');
        if (customBtn) {
          customBtn.style.backgroundColor = '#FF6B00';
          customBtn.style.borderColor = '#FF6B00';
          customBtn.style.color = 'white';
          customBtn.style.fontWeight = '600';
        }
        
        // Update current date range and refresh chart
        currentDateRange = 'custom';
        updateEventTrendsChart();
      });
    }

    // Set default active button (This Week)
    const weekBtn = document.querySelector('[data-range="week"]');
    if (weekBtn) {
      weekBtn.style.backgroundColor = '#FF6B00';
      weekBtn.style.borderColor = '#FF6B00';
      weekBtn.style.color = 'white';
      weekBtn.style.fontWeight = '600';
    }
    
    // Refresh data every 30 seconds
    setInterval(() => {
      fetchIncidentsData();
      fetchTanodData();
    }, 30000);
  }

  /**
   * Show/hide charts based on selection
   */
  function showChart(chartType) {
    const trendsCanvas = document.getElementById('trendsChart');
    const typeCanvas = document.getElementById('typeChart');
    const severityCanvas = document.getElementById('severityChart');

    console.log('[Analytics] showChart called with type:', chartType);

    // Hide all charts
    if (trendsCanvas) trendsCanvas.style.display = 'none';
    if (typeCanvas) typeCanvas.style.display = 'none';
    if (severityCanvas) severityCanvas.style.display = 'none';

    // Show selected chart
    switch (chartType) {
      case 'trends':
        if (trendsCanvas) {
          trendsCanvas.style.display = 'block';
          console.log('[Analytics] Showing trends chart');
        }
        break;
      case 'type':
        if (typeCanvas) {
          typeCanvas.style.display = 'block';
          console.log('[Analytics] Showing type chart');
        }
        break;
      case 'severity':
        if (severityCanvas) {
          severityCanvas.style.display = 'block';
          console.log('[Analytics] Showing severity chart');
        }
        break;
    }
  }

  /**
   * Ensure incidents have location data (use defaults if missing)
   */
  function enrichIncidentsWithLocations() {
    // Manila city center coordinates
    const centerLat = 14.2735;
    const centerLng = 121.0471;
    const radiusVariance = 0.05; // About 5km radius

    allIncidents.forEach((incident, index) => {
      // If incident doesn't have coordinates, generate mock ones near Manila
      if (!incident.latitude || !incident.longitude) {
        incident.latitude = centerLat + (Math.random() - 0.5) * radiusVariance;
        incident.longitude = centerLng + (Math.random() - 0.5) * radiusVariance;
        console.log(`[Analytics] Generated location for incident ${incident.id}`);
      }
    });
  }

  /**
   * Get color based on incident severity
   */
  function getSeverityColor(severity) {
    switch(severity) {
      case 'CRITICAL': return '#FF0000'; // Red
      case 'HIGH': return '#FF6B00';     // Orange
      case 'MEDIUM': return '#FFC107';   // Yellow
      case 'LOW': return '#4CAF50';      // Green
      default: return '#9E9E9E';         // Gray
    }
  }

  /**
   * Initialize and update the map with incident data
   */
  function initializeMapWithIncidents() {
    const mapElement = document.getElementById('map');
    if (!mapElement) return;

    console.log('[Analytics] Initializing map with incidents');

    // Default center (Philippines - Manila area)
    const defaultCenter = { lat: 14.2735, lng: 121.0471 };

    // Create map
    let map = new google.maps.Map(mapElement, {
      zoom: 13,
      center: defaultCenter,
      mapTypeId: 'roadmap',
      styles: [
        {
          featureType: 'poi',
          elementType: 'labels',
          stylers: [{ visibility: 'off' }]
        }
      ]
    });

    // Store markers for cleanup
    let markers = [];
    let heatmapLayer = null;

    /**
     * Update map with current incidents
     */
    function updateMapWithIncidents() {
      // Clear existing markers
      markers.forEach(marker => marker.setMap(null));
      markers = [];

      // Clear existing heatmap
      if (heatmapLayer) {
        heatmapLayer.setMap(null);
      }

      if (allIncidents.length === 0) {
        console.log('[Analytics] No incidents to display on map');
        return;
      }

      // Prepare data for markers and heatmap
      const heatPoints = [];
      const incidentsByLocation = {};

      // Group incidents by location
      allIncidents.forEach(incident => {
        if (incident.latitude && incident.longitude) {
          const locKey = `${incident.latitude},${incident.longitude}`;
          if (!incidentsByLocation[locKey]) {
            incidentsByLocation[locKey] = [];
          }
          incidentsByLocation[locKey].push(incident);
          heatPoints.push(new google.maps.LatLng(incident.latitude, incident.longitude));
        }
      });

      console.log('[Analytics] Found', Object.keys(incidentsByLocation).length, 'unique incident locations');

      // Create markers for each location
      Object.entries(incidentsByLocation).forEach(([locKey, incidents]) => {
        const [lat, lng] = locKey.split(',').map(Number);
        
        // Get most severe incident at this location
        const mostSevere = incidents.reduce((prev, current) => {
          const severityOrder = { 'CRITICAL': 0, 'HIGH': 1, 'MEDIUM': 2, 'LOW': 3 };
          const prevSev = severityOrder[prev.severity] || 4;
          const currSev = severityOrder[current.severity] || 4;
          return currSev < prevSev ? current : prev;
        });

        const color = getSeverityColor(mostSevere.severity);

        // Create custom marker icon
        const markerIcon = {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 8,
          fillColor: color,
          fillOpacity: 0.8,
          strokeColor: '#fff',
          strokeWeight: 2
        };

        const marker = new google.maps.Marker({
          position: { lat, lng },
          map: map,
          title: `${incidents.length} incident(s)`,
          icon: markerIcon,
          animation: google.maps.Animation.DROP
        });

        // Create info window with incident details
        const incidentList = incidents
          .map(i => `<div style="margin: 5px 0; font-size: 12px;">
            <strong>${i.type}</strong> - ${i.severity}<br>
            Status: ${i.status || 'Unknown'}<br>
            Description: ${i.description || 'N/A'}
          </div>`)
          .join('');

        const infoWindow = new google.maps.InfoWindow({
          content: `<div style="width: 250px; color: #333;">
            <h4 style="margin: 0 0 10px 0; color: ${color};">Incident Location</h4>
            <div style="font-size: 12px; margin-bottom: 10px;">
              <strong>Total Incidents:</strong> ${incidents.length}<br>
              <strong>Most Severe:</strong> <span style="color: ${color}; font-weight: bold;">${mostSevere.severity}</span><br>
              <strong>Location:</strong> ${lat.toFixed(4)}, ${lng.toFixed(4)}
            </div>
            <div style="border-top: 1px solid #ddd; padding-top: 10px; max-height: 200px; overflow-y: auto;">
              ${incidentList}
            </div>
          </div>`
        });

        // Show info window on marker click
        marker.addListener('click', () => {
          // Close all other info windows by recreating them
          infoWindow.open(map, marker);
        });

        markers.push(marker);
      });

      // Create heatmap layer if there are points
      if (heatPoints.length > 0) {
        heatmapLayer = new google.maps.visualization.HeatmapLayer({
          data: heatPoints,
          map: map,
          radius: 50,
          opacity: 0.6,
          dissipating: true,
          gradient: [
            '#4CAF50', // Green - Low
            '#FFC107', // Yellow - Medium
            '#FF6B00', // Orange - High
            '#FF0000'  // Red - Critical
          ]
        });

        console.log('[Analytics] Heatmap layer created with', heatPoints.length, 'points');
      }

      // Adjust map bounds to fit all markers
      if (markers.length > 0) {
        const bounds = new google.maps.LatLngBounds();
        markers.forEach(marker => bounds.extend(marker.getPosition()));
        map.fitBounds(bounds);
        
        // Add padding if only one marker
        if (markers.length === 1) {
          map.setZoom(13);
        }
      }
    }

    // Update map when data is fetched
    updateMapWithIncidents();

    // Store update function for refresh
    window.updateMapWithIncidents = updateMapWithIncidents;
  }

  /**
   * Create legend for severity colors
   */
  function createMapLegend() {
    const mapElement = document.getElementById('map');
    if (!mapElement) return;

    const legendDiv = document.createElement('div');
    legendDiv.id = 'mapLegend';
    legendDiv.style.cssText = `
      position: absolute;
      top: 10px;
      right: 10px;
      background: white;
      padding: 12px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
      font-size: 12px;
      font-family: Arial, sans-serif;
      z-index: 10;
      max-width: 200px;
    `;

    legendDiv.innerHTML = `
      <div style="font-weight: 600; margin-bottom: 8px; color: #333; font-size: 13px;">Severity</div>
      <div style="display: flex; align-items: center; margin: 6px 0;">
        <div style="width: 14px; height: 14px; border-radius: 50%; background: #FF0000; margin-right: 8px; border: 2px solid white; box-shadow: 0 0 2px rgba(0,0,0,0.3);"></div>
        <span style="color: #333;">Critical</span>
      </div>
      <div style="display: flex; align-items: center; margin: 6px 0;">
        <div style="width: 14px; height: 14px; border-radius: 50%; background: #FF6B00; margin-right: 8px; border: 2px solid white; box-shadow: 0 0 2px rgba(0,0,0,0.3);"></div>
        <span style="color: #333;">High</span>
      </div>
      <div style="display: flex; align-items: center; margin: 6px 0;">
        <div style="width: 14px; height: 14px; border-radius: 50%; background: #FFC107; margin-right: 8px; border: 2px solid white; box-shadow: 0 0 2px rgba(0,0,0,0.3);"></div>
        <span style="color: #333;">Medium</span>
      </div>
      <div style="display: flex; align-items: center; margin: 6px 0;">
        <div style="width: 14px; height: 14px; border-radius: 50%; background: #4CAF50; margin-right: 8px; border: 2px solid white; box-shadow: 0 0 2px rgba(0,0,0,0.3);"></div>
        <span style="color: #333;">Low</span>
      </div>
    `;

    mapElement.appendChild(legendDiv);
  }

  document.addEventListener('DOMContentLoaded', () => {
    try {
      Logger.info('Analytics page initialization started');

      // Initialize analytics with real data
      initializeAnalytics();

      // Initialize map after a brief delay to ensure Google Maps is loaded
      setTimeout(() => {
        initializeMapWithIncidents();
        createMapLegend();
      }, 1000);

      // Setup logout functionality
      const signoutBtn = document.getElementById('logoutBtn');
      if (signoutBtn) {
        signoutBtn.addEventListener('click', (e) => {
          e.preventDefault();
          try {
            Logger.info('User initiated logout');
            // Clear all authentication data
            if (typeof StorageHelper !== 'undefined') {
              StorageHelper.remove('sentinel_logged_in');
            } else {
              localStorage.removeItem('sentinel_logged_in');
              sessionStorage.clear();
            }
            // Redirect to login page
            window.location.href = './login.html';
          } catch (error) {
            Logger.error('Logout error', error.message);
            console.error('Logout failed:', error);
            // Force redirect to login
            window.location.href = './login.html';
          }
        });
      } else {
        Logger.warn('Logout button not found');
      }

      Logger.info('Analytics page initialization completed');

    } catch (error) {
      Logger.error('Critical error during analytics initialization', error.message);
      console.error('Analytics init error:', error);
    }
  });

  /**
   * Notification UI is handled by shared-notification-ui.js
   */

  /**
   * Filter Info Icon Click Handler - Analytics
   */
  const filterInfoIcon = document.getElementById('filterInfoIcon');
  if (filterInfoIcon) {
    filterInfoIcon.addEventListener('click', () => {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.5); display: flex;
        justify-content: center; align-items: center; z-index: 10000;
        animation: fadeIn 0.3s ease;
      `;

      const modalContent = document.createElement('div');
      modalContent.style.cssText = `
        background: white; border-radius: 12px; padding: 30px;
        max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        animation: slideUp 0.3s ease;
      `;

      modalContent.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2 style="margin: 0; color: #333; font-size: 22px;">
            <i class="fa-solid fa-chart-simple" style="color: #B00020; margin-right: 10px;"></i>
            Analytics
          </h2>
          <button id="closeModal" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">
            <i class="fa-solid fa-times"></i>
          </button>
        </div>

        <div style="color: #666; line-height: 1.8;">
          <p><strong>View comprehensive data visualizations and insights about incident patterns and trends.</strong></p>

          <div style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px; border-left: 4px solid #B00020;">
            <h3 style="margin: 0 0 10px 0; color: #333;">Statistics Cards</h3>
            <p style="margin: 0;">See key metrics at a glance:</p>
            <ul style="margin: 8px 0 0 0; padding-left: 20px;">
              <li><strong>Total Incidents</strong> - All-time incident count</li>
              <li><strong>Resolved</strong> - Completed incidents</li>
              <li><strong>In Progress</strong> - Active incidents</li>
            </ul>
          </div>

          <div style="margin-top: 15px; padding: 15px; background: #f5f5f5; border-radius: 8px; border-left: 4px solid #B00020;">
            <h3 style="margin: 0 0 10px 0; color: #333;">Charts & Graphs</h3>
            <p style="margin: 0;">Analyze incident data through:</p>
            <ul style="margin: 8px 0 0 0; padding-left: 20px;">
              <li><strong>Incidents by Type</strong> - Category distribution</li>
              <li><strong>Incidents by Severity</strong> - Priority breakdown</li>
              <li><strong>Incidents Over Time</strong> - Trend analysis</li>
              <li><strong>Response Time Analytics</strong> - Performance metrics</li>
            </ul>
          </div>

          <div style="margin-top: 15px; padding: 15px; background: #f5f5f5; border-radius: 8px; border-left: 4px solid #B00020;">
            <h3 style="margin: 0 0 10px 0; color: #333;">Interactive Features</h3>
            <p style="margin: 0;">Hover over charts to see detailed values, click legend items to show/hide data series, and use filters to focus on specific periods.</p>
          </div>

          <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
            <p style="margin: 0;"><strong> Tip:</strong> Use date range filters to compare incident trends between different time periods and identify patterns.</p>
          </div>
        </div>

        <div style="margin-top: 25px; display: flex; justify-content: flex-end; gap: 10px;">
          <button id="closeModalBtn" style="background: white; border: 2px solid #B00020; color: #B00020; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s;">Close</button>
        </div>
      `;

      modal.appendChild(modalContent);
      document.body.appendChild(modal);

      const closeButton = document.getElementById('closeModal');
      const closeButtonBtn = document.getElementById('closeModalBtn');
      
      const closeModal = () => {
        modal.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => modal.remove(), 300);
      };

      closeButton.addEventListener('click', closeModal);
      closeButtonBtn.addEventListener('click', closeModal);
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });

      const escapeHandler = (e) => {
        if (e.key === 'Escape') {
          closeModal();
          document.removeEventListener('keydown', escapeHandler);
        }
      };
      document.addEventListener('keydown', escapeHandler);
    });
  }
</script>

</body>
</html>